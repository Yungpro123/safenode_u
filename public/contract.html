<!DOCTYPE html>  
<html lang="en">  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  
<title>SafeNode — Start Payment</title>  
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">  
<link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" sizes="32x32" type="image/png">    
<link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" sizes="16x16" type="image/png">    
<link rel="apple-touch-icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png">    
<script src="/dashboard/actions.js"></script>    

<style>  
* { box-sizing: border-box; font-family: 'Inter', sans-serif;}  
    :root{
      --primary:#00a86b;
      --primary-light:#d4f7e8;
      --dark:#111;
      --gray:#555;
      --bg-gradient:linear-gradient(135deg,#f6fbff 0%,#f3fff9 100%);
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --ease-cubic:cubic-bezier(.2,.9,.2,1);
    }
body { margin:0; background: linear-gradient(160deg,#e8f9f0 0%,#f0f5ff 100%); display:flex; justify-content:center; min-height:100vh; padding-top: env(safe-area-inset-top);}  
.container { width:100%; max-width:480px; overflow:hidden; border-radius:24px;}  
.screens { display:flex; width:200%; transition: transform 0.5s cubic-bezier(0.77,0,0.175,1);}  
.screen { width:50%; padding:24px; min-height:100vh; display:flex; flex-direction:column;}  
.screen2 { width:50%; padding:15px; min-height:100vh; display:flex; flex-direction:column;}  
.back-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #00a86b;
    margin-bottom: 10px;
    cursor: pointer;
    padding: 6px;
    width: 40px;
}

.header { font-size:20px; font-weight:700; color:#00a86b; margin-bottom:20px;}  
.input-group { display:flex; flex-direction:column; margin-bottom:20px;}  
    label {
      font-size: 13px;
      color: var(--text-dark);
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid #ccc;
      margin-bottom: 18px;
      font-size: 15px;
      transition: 0.3s;
    }

    input:focus {
      border-color: #ccc;
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }

    input[readonly] { background: #f7f7f7; cursor: not-allowed; }

.next-btn {  
  width: 100%;
      margin-top: 70px;
      background: #00a86b;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
}  
.view-btn{
  display:inline-block;margin-top:9px;background:white;color:black;
      border:none;border-radius:8px;padding:12px;cursor:pointer;z-index:1300;
      text-decoration: none;
      align-items:center;gap:8px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.08);
      float: right;
}
.next-btn:hover {  
  transform: translateY(-2px);  
  box-shadow:0 10px 25px rgba(0,168,107,0.35);
}  

/* INVITE BUTTON */
.invite-btn {
  width: 100%;
  margin-top: 12px;
  background: transparent;
  color: #00a86b;
  border: 2px solid #00a86b;
  border-radius: 12px;
  padding: 14px;
  font-weight: 600;
  cursor: pointer;
  font-size: 16px;
  transition: 0.25s;
}


/* CANCEL BUTTON (OPTION B) */
.cancel-btn {
  width: 100%;
  margin-bottom: 12px;
  background: #ffffff;
  color: #ff3b30;
  border: 2px solid #ff3b30;
  border-radius: 12px;
  padding: 14px;
  font-weight: 600;
  cursor: pointer;
  font-size: 16px;
  transition: 0.25s;
}

.cancel-btn:hover {
  background: #ff3b30;
  color: #fff;
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(255,59,48,0.25);
}

.recent-list { margin-top:10px; max-height:250px;  border-radius:12px; border:1px solid #e0e0e0; background:#fff; box-shadow:0 5px 15px rgba(0,0,0,0.05);}  
.recent-item { padding:10px; display:flex; align-items:center; border-bottom:1px solid #f0f0f0; cursor:pointer; transition:0.2s;}  
.recent-item:last-child { border-bottom:none;}  
.recent-item:hover { background: rgba(0,168,107,0.08);}  
.rec-icon { width:40px; height:40px; border-radius:50%; background: rgba(0,168,107,0.1); display:flex; align-items:center; justify-content:center; font-size:18px; color:#00a86b; margin-right:12px;}  
.rec-info .name { font-weight:600; color:#222;}  
.rec-info .details { font-size:13px; color:#555;}  
.loader { display:none; justify-content:center; align-items:center; margin-bottom:10px;}  
.loader.active { display:flex;}  
.loader span { margin-left:8px; font-size:14px; color:#555;}  

    form {
      width: 100%;
      
      border-radius: 18px;
      padding: 32px 28px;
      
    }

    .logo { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:20px; }
    .logo img { width:32px; height:32px; border-radius:7px; transition: transform .3s ease; }
    .logo img:hover { transform: scale(1.15) rotate(8deg); }
    .logo span { font-size:22px; font-weight:700; color:#00a86b; }

    h2 { color:#0b513f; text-align:center; font-size:20px; font-weight:600; margin-bottom:20px; }

    label {
      font-size: 13px;
      color: var(--text-dark);
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    
    .btn { width:100%; margin-top:22px; padding:14px; border-radius:12px; border:none; background:#00a86b; color:#fff; font-weight:700; cursor:pointer; font-size:16px; transition:all .3s ease; }
    .btn:hover { background:#00945f; }
.loader-overlay {
  position: fixed;       /* covers entire screen */
  display: flex;         /* centers content */
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.85);
  z-index: 9999;
  visibility: hidden;
  opacity: 0;
  transition: opacity .3s ease, visibility .3s ease;
}

.loader-overlay.active {
  visibility: visible;
  opacity: 1;
}

.spinner {
  border: 4px solid #e0e0e0;
  border-top: 4px solid #00bb55;
  border-radius: 50%;
  width: 40px;
  margin:0;
  top: 0;
  display:flex;
  height: 40px;
  position:fixed;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 12px;
  font-size: 14px;
  color: #555;
  text-align: center;
}
    #amountGroup, #chargeSection, #feeSummary { display:none; }
    #feeSummary { background:#f7fef9; border:1px solid #dff5e5; border-radius:10px; padding:12px 14px; margin-top:14px; font-size:14px; color:#055e38; line-height:1.5; }

    /* --- Dropdown Styles --- */
    .dropdown { position: relative; user-select: none; margin-top: 6px; }
    .dropdown-selected { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; font-size: 15px; cursor: pointer; transition: all 0.25s ease; }
    .dropdown-selected:hover { border-color: #00bb55; box-shadow: 0 0 10px rgba(0,187,85,0.2); }
    .dropdown-options { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 10px 25px rgba(0,0,0,0.08); overflow: hidden; max-height: 0; opacity: 0; pointer-events: none; transition: all 0.25s ease; z-index: 10; }
    .dropdown.active .dropdown-options { max-height: 180px; opacity: 1; pointer-events: auto; }
    .dropdown-options div { padding: 12px 14px; cursor: pointer; font-size: 14px; transition: background 0.2s ease; }
    .dropdown-options div:hover { background: #e8f9f0; }

    @media (max-width: 640px) {
      form { padding: 24px 16px; }
    }
</style>  
</head>  
<!-- Only the body part, rest of head stays the same -->
<body>
  <!-- Add this modal somewhere in your body -->
<div id="recentsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:#fff; border-radius:12px; max-width:400px; width:90%; max-height:80%; overflow-y:auto; padding:20px; position:relative;">
    <button id="closeModal" style="position:absolute; top:10px; right:10px; font-size:18px;border:none;outline:none;background:none">&times;</button>
    <div id="modalRecentsList"></div>
  </div>
</div>
<div class="container">
  <div class="screens" id="screens">

    <!-- Screen 1 -->
    <div class="screen" id="selectScreen">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="header">Create contract</div>
      <div class="input-group">
        <label class="input-label">Recipient Email</label>
        <input type="email" id="sellerSearch" placeholder="Type seller email">
      </div>
      <div class="loader" id="loader"><i class="fas fa-spinner fa-spin"></i><span>Searching...</span></div>
      <div class="header">Recents</div>
      <div class="recent-list" id="recentList"></div>
      <button class="next-btn" id="nextBtn" disabled>Next</button>
   <a href='/lnk' style="text-decoration:none;">  <button class="invite-btn"  >Create Payment Link</button>
      </a>
    </div>

    <!-- Screen 2 (MODULAR) -->
    <div class="screen2" id="formScreen">
      <div id="screen2Content">
        <!-- Put any content you want here -->
        <button class="back-btn" onclick="goBack()">
  <i class="fas fa-arrow-left"></i>
</button>
    <form id="contractForm">

      <h2>Create Contract</h2>
            <p style="height:10px"></p>

      <label>Contract Title</label>
      <input id="title" placeholder="Contract title" required />
      <label>Description</label>
      <input id="description" placeholder="Description" required />

      <!-- Payment Dropdown -->
      <label>Payment Method</label>
      <div class="dropdown" id="paymentDropdown">
        <div class="dropdown-selected">Select payment method</div>
        <div class="dropdown-options" id="paymentOptions">
          <div data-value="wallet" style="font-weight:500">Wallet — <span id="walletInlineBalance" style="color:#00a86b;font-weight:600">₦0.00</span></div>
        </div>
      </div>

      <div id="amountGroup">
        <label>Amount (<span id="currencyLabel">₦</span>)</label>
        <input id="amount" type="number" placeholder="Enter amount" required />
      </div>

      <div id="chargeSection">
        <label>Who Pays the SafeNode Fee?</label>
        <div class="dropdown" id="chargeDropdown">
          <div class="dropdown-selected">Select option</div>
          <div class="dropdown-options">
            <div data-value="buyer">Buyer Pays All (6%)</div>
            <div data-value="seller">Seller Pays All (6%)</div>
            <div data-value="split">Split 50 / 50</div>
          </div>
        </div>
      </div>

      <div id="feeSummary"></div>
      <button class="btn" type="submit" id="payBtn">Continue</button>
    </form>
  

  <div class="loader-overlay" id="load">
  </div>


  </div>
</div>
</div>
<!-- FULL-PAGE LOADER -->
<div id="fullPageLoader" class="loader-overlay">
  <div style="text-align:center;">
    <div class="spin"></div>

  </div>
</div>

<style>
.loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  visibility: hidden;
  opacity: 0;
  transition: opacity .3s ease, visibility .3s ease;
}

.loader-overlay.active {
  visibility: visible;
  opacity: 1;
}

.spin {
  width: 30px;   /* smaller size */
  height: 30px;
  border: 4px solid var(--primary-light); /* light part of the circle */
  border-top-color: var(--primary);      /* active color */
  border-radius: 50%;
  animation: spinn 0.8s linear infinite;
}

@keyframes spinn {
  to { transform: rotate(360deg); }
}


</style>
<script>
(function(){
  let selectedSeller = null;
  let recentSellers = [];const loaderOverlay = document.getElementById("fullPageLoader");

async function loadRecents() {
  loaderOverlay.classList.add("active"); // show loader
  try {
    const userId = localStorage.getItem("ui");
    if (!userId) return;

    const res = await fetch(`/api/users/recents`, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId })
    });
    const data = await res.json();
    if (data.success) {
      recentSellers = data.recents.map(r => ({
        name: r.name,
        value: r.email
      }));
    }
    renderRecent(recentSellers);
  } catch (err) {
    console.error("Error loading recents:", err);
  } finally {
    loaderOverlay.classList.remove("active"); // hide loader
  }
}
  

  const sellerSearch = document.getElementById('sellerSearch');
  const recentList = document.getElementById('recentList');
  const loader = document.getElementById('loader'); // rename if needed to avoid conflict
  const nextBtn = document.getElementById('nextBtn');
  const screens = document.getElementById('screens');

  function goInvite(){
    window.location.href = "/contract.html";
    }

function renderRecent(list) {
  recentList.innerHTML = '';

  // Show only first 4 items
  const limited = list.slice(0, 4);

  limited.forEach(s => {
    const div = createRecentItem(s);
    recentList.appendChild(div);
  });

  // Show "View All" button if more than 4
  if (list.length > 4) {
    const viewAllBtn = document.createElement('button');
    viewAllBtn.textContent = "View All";
    viewAllBtn.className = "view-btn";
    viewAllBtn.style.marginTop = "10px";
    viewAllBtn.onclick = () => showModal(list);
    recentList.appendChild(viewAllBtn);
  }
}

// Creates a single recent item (used in both list and modal)
function createRecentItem(s) {
  const div = document.createElement('div');
  div.className = 'recent-item';
  div.innerHTML = `
    <span class="rec-icon">${s.name.charAt(0).toUpperCase()}</span>
    <div class="rec-info">
      <div class="name">${s.name}</div>
      <div class="details">${s.value}</div>
    </div>
  `;

  if (s.name === "Not Found" || s.name === "Error fetching user") {
    div.style.opacity = "0.5";
    div.style.cursor = "not-allowed";
  } else {
    div.onclick = () => selectSeller(s); // fills input & enables next button
    nextBtn.disabled = false;
  }
  return div;
}

// Modal logic
const modal = document.getElementById("recentsModal");
const modalList = document.getElementById("modalRecentsList");
document.getElementById("closeModal").onclick = () => { modal.style.display = "none"; };

function showModal(list) {
  modalList.innerHTML = "";
  list.forEach(s => {
    const div = createRecentItem(s);
    // Close modal on click
    div.onclick = () => { selectSeller(s); modal.style.display = "none"; };
    modalList.appendChild(div);
  });
  modal.style.display = "flex";
}
  function selectSeller(s){
    selectedSeller = s;
    sellerSearch.value = s.value;
    nextBtn.disabled = false;
    // Save to localStorage
    localStorage.setItem('sellerContact', s.value);
    localStorage.setItem('sellerName', s.name);
    screens.style.transform='translateX(-50%)';
}

  sellerSearch.addEventListener('input', async () => {
  const query = sellerSearch.value.trim().toLowerCase();
  nextBtn.disabled = true;
  if (!query) return renderRecent(recentSellers);
  loader.classList.add('active');

  const filtered = recentSellers.filter(s => s.value.toLowerCase().includes(query));
  
  // initially render filtered recents
  renderRecent(filtered);

  try {
    const res = await fetch(`/api/users/search?email=${query}`, { credentials: 'include' });
    const data = await res.json();

    if (data.success && data.user) {
      const user = { name: data.user.username || data.user.email, value: data.user.email };
      renderRecent([user, ...filtered]);
    } else {
      // user not found — show "Not Found" message
      renderRecent([{ name: "Not Found", value: query }]);
    }
  } catch (err) {
    console.error(err);
    renderRecent([{ name: "Error fetching user", value: query }]);
  }

  loader.classList.remove('active');
});

  nextBtn.addEventListener('click', ()=>{
    if(!sellerSearch.value) return;
    const selected = recentSellers.find(s=>s.value===sellerSearch.value) || {name: sellerSearch.value, value:sellerSearch.value};
    selectSeller(selected);
  });

  function submitContract(){
    const title = document.getElementById('contractTitle').value.trim();
    const desc = document.getElementById('contractDescription').value.trim();
    const amount = document.getElementById('contractAmount').value.trim();
    if(!title||!desc||!amount){ alert('Fill all fields'); return; }

    localStorage.setItem('sellerContact', selectedSeller.value);
    localStorage.setItem('sellerName', selectedSeller.name);
    localStorage.setItem('contractTitle', title);
    localStorage.setItem('contractDescription', desc);
    localStorage.setItem('contractAmount', amount);

    window.location.href='/contract.html';
  }

  function cancelForm() { screens.style.transform = 'translateX(0)'; }

  // EASY REPLACE FUNCTION
  function replaceScreen2(htmlContent){
    document.getElementById('screen2Content').innerHTML = htmlContent;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await loadRecents();   // <-- THIS CALLS YOUR API
    renderRecent(recentSellers); // <-- THIS WILL NOW WORK
});
})();
</script>

  <script>
    const form = document.getElementById("contractForm");
    const loader = document.getElementById("load");
    const payBtn = document.getElementById("payBtn");
    const amountInput = document.getElementById("amount");
    const amountGroup = document.getElementById("amountGroup");
    const chargeSection = document.getElementById("chargeSection");
    const feeSummary = document.getElementById("feeSummary");
    const currencyLabel = document.getElementById("currencyLabel");
    const walletInlineBalance = document.getElementById("walletInlineBalance");

    
    const buyerId = localStorage.getItem("ui");
    if (!buyerId) { showToast("⚠️ Please log in first.","error"); setTimeout(() => window.location.href = "/auth", 1500); }

    let buyerEmail = null;
    let walletBalance = 0;
    let walletCurrency = "₦";

    async function getUserInfo() {
      try {
        const res = await fetch(`/api/users/${buyerId}`, { credentials: "include" });
        const data = await res.json();
        if (data.success && data.user) {
          buyerEmail = data.user.email;
          walletBalance = data.user.wallet?.balance || 0;
          const userCurrency = data.user.currency || "NGN";
          if (userCurrency === "USDT") walletCurrency = "USDT";
          else if (userCurrency === "USD") walletCurrency = "$";
          else if (userCurrency === "GBP") walletCurrency = "£";
          else if (userCurrency === "EUR") walletCurrency = "€";
          else walletCurrency = "₦";
          walletInlineBalance.textContent = walletCurrency === "USDT" ? `${walletBalance.toFixed(2)} USDT` : `${walletCurrency}${walletBalance.toFixed(2)}`;
        } else throw new Error("Invalid user data");
      } catch (err) {
        console.error("❌ Error fetching user:", err);
        localStorage.removeItem("ui");
        setTimeout(() => window.location.href = "/auth", 2000);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => { payBtn.disabled = true; await getUserInfo(); payBtn.disabled = false; });

    function setupDropdown(id, callback) {
      const dropdown = document.getElementById(id);
      const selected = dropdown.querySelector(".dropdown-selected");
      const options = dropdown.querySelector(".dropdown-options");
      selected.addEventListener("click", () => { dropdown.classList.toggle("active"); });
      options.querySelectorAll("div").forEach(opt => { opt.addEventListener("click", () => { const value = opt.dataset.value; const label = opt.textContent; selected.textContent = label; dropdown.classList.remove("active"); callback(value); }); });
      document.addEventListener("click", (e) => { if (!dropdown.contains(e.target)) dropdown.classList.remove("active"); });
    }

    let paymentMethod = "";
    let chargePayer = "";

    setupDropdown("paymentDropdown", (value) => {
      paymentMethod = value;
      if (!value) { amountGroup.style.display = "none"; chargeSection.style.display = "none"; feeSummary.style.display = "none"; }
      else { amountGroup.style.display = "block"; currencyLabel.textContent = value === "wallet" ? (walletCurrency==="USDT"?"USDT":walletCurrency) : (value==="usdt"?"USDT":"₦"); }
    });

    setupDropdown("chargeDropdown", (value) => { chargePayer = value; updateFeeSummary(); });

    amountInput.addEventListener("input", () => {
      const value = parseFloat(amountInput.value);
      if (value>0) { chargeSection.style.display="block"; updateFeeSummary(); } else { chargeSection.style.display="none"; feeSummary.style.display="none"; }
    });

    function updateFeeSummary() {
      const amount = parseFloat(amountInput.value)||0;
      const method = paymentMethod;
      const isUSDT = method==="usdt" || walletCurrency==="USDT";
      if(!amount||!chargePayer) return (feeSummary.style.display="none");
      const fee = amount*0.06;
      let total = amount;
      if(chargePayer==="buyer") total = amount+fee;
      else if(chargePayer==="split") total = amount+fee/2;
      const formatAmount = (amt) => isUSDT ? `${amt.toFixed(2)} USDT` : `${walletCurrency}${amt.toFixed(2)}`;
      let text = `<strong>SafeNode Fee (6%):</strong> ${formatAmount(fee)}<br>`;
      if(chargePayer==="buyer") text+=`You pay <strong>${formatAmount(total)}</strong> total.`;
      else if(chargePayer==="seller") text+=`Seller receives <strong>${formatAmount(amount-fee)}</strong>.`;
      else text+=`Buyer pays <strong>${formatAmount(amount+fee/2)}</strong>, seller contributes <strong>${formatAmount(fee/2)}</strong>.`;
      feeSummary.innerHTML = text;
      feeSummary.style.display="block";
    }
const loaderOverlay = document.getElementById("fullPageLoader");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!buyerEmail) return showToast("Please wait, verifying account...","error");
      const title=document.getElementById("title").value.trim();
      const description=document.getElementById("description").value.trim();
      const amount=parseFloat(amountInput.value);
      if(!paymentMethod||!amount||!chargePayer) return showToast("Please fill all required fields.","error");
      if(paymentMethod==="wallet" && amount>walletBalance) return showToast(`Insufficient wallet balance (${walletCurrency}${walletBalance.toFixed(2)} available).`,'error');
            payBtn.disabled=true;
      try{
              loaderOverlay.classList.add("active"); // show loader
      const se = localStorage.getItem('sellerContact') || sellerSearch.value;
const sn = localStorage.getItem('sellerName') || sellerSearch.value.split("@")[0];
      const payload = {
  title,
  description,
  amount,
  buyerEmail,
  paymentMethod,
  chargePayer,
  sellerEmail: se,
  sellerName: sn,
};
        const res=await fetch(`/api/contracts/create`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const data=await res.json();
        
        payBtn.disabled=false;
        if(data.success){
          if(paymentMethod==="wallet"){
           const loaderOverlay = document.getElementById("fullPageLoader");
            loaderOverlay.classList.remove("active"); // hide loader
            window.location.href=`/success?id=${data.contractId}`;}
          else if(data.paymentUrl){window.location.href=data.paymentUrl;}
        } else showToast(data.message || "Failed to create contract.",'error');
      } catch(err){  payBtn.disabled=false; console.error("Network error:",err); showToast("⚠️ Cannot reach server. Try again.",'error'); }
    });
    
    function goBack() {
  const screens = document.getElementById('screens');
  screens.style.transform = 'translateX(0)'; // slide back to screen 1
}
  </script>
</body>