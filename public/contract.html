<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SafeNode — Secure Payment</title>
<link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png">
<script src="/js/dashboard.js"></script>
<style>
  * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
  body {
    background: linear-gradient(135deg,#e8f9f0 0%,#f0f5ff 100%);
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    font-weight: 500;
    padding:16px;
    overflow-x:hidden;
    animation: fadeIn 0.8s ease-in;
  }

  @keyframes fadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
  @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }
  @keyframes spin { to { transform:rotate(360deg); } }

  .card {
    width:100%;
    max-width:420px;
    background:#fff;
    border-radius:18px;
    padding:32px 28px;
    box-shadow:0 10px 40px rgba(0,0,0,0.08);
    position:relative;
    animation: float 5s ease-in infinite;
  }

  .logo { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:20px; }
  .logo img { width:32px; height:32px; border-radius:7px; transition: transform .3s ease; }
  .logo img:hover { transform: scale(1.15) rotate(8deg); }
  .logo span { font-size:22px; font-weight:700; color:#00a86b; }

  h2 { color:#0b513f; text-align:center; font-size:20px; font-weight:600; margin-bottom:20px; }

  label { display:block; margin-top:12px; font-weight:600; font-size:15px; color:#222; }
  input {
    width:100%; padding:12px; border-radius:10px; border:1px solid #e0e0e0; margin-top:6px; font-size:15px;
    transition: all .25s ease;
  }
  input:focus { outline:none; border-color:#00bb55; box-shadow:0 0 10px rgba(0,187,85,0.2); transform:scale(1.01); }

  .btn {
    width:100%; margin-top:22px; padding:14px; border-radius:12px;
    border:none; background:#00a86b; color:#fff; font-weight:700; cursor:pointer; font-size:16px;
    transition:all .3s ease;
  }
  .btn:hover { background:#00945f; }

  .loader-overlay {
    position:absolute; inset:0; background:rgba(255,255,255,.85);
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    visibility:hidden; opacity:0; transition:opacity .3s ease, visibility .3s ease;
    border-radius:18px;
  }
  .loader-overlay.active { visibility:visible; opacity:1; }
  .spinner { border:4px solid #e0e0e0; border-top:4px solid #00bb55; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }

  #amountGroup, #chargeSection, #feeSummary { display:none; }
  #feeSummary {
    background:#f7fef9; border:1px solid #dff5e5; border-radius:10px;
    padding:12px 14px; margin-top:14px; font-size:14px; color:#055e38; line-height:1.5;
  }

  .dropdown {
    position: relative;
    user-select: none;
    margin-top: 6px;
  }

  .dropdown-selected {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 12px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.25s ease;
  }

  .dropdown-selected:hover {
    border-color: #00bb55;
    box-shadow: 0 0 10px rgba(0,187,85,0.2);
  }

  .dropdown-options {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: #fff;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    pointer-events: none;
    transition: all 0.25s ease;
    z-index: 10;
  }

  .dropdown.active .dropdown-options {
    max-height: 180px;
    opacity: 1;
    pointer-events: auto;
  }

  .dropdown-options div {
    padding: 12px 14px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s ease;
  }

  .dropdown-options div:hover { background: #e8f9f0; }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9999;
  }
  #toast.show { opacity: 1; pointer-events: auto; }
</style>
</head>
<body>
<div class="card">
  <div class="logo">
    <img src="../logo.png" alt="SafeNode Logo" />
    <span>SafeNode</span>
  </div>
  <h2>Start a Secure Payment</h2>
  <form id="contractForm">
    <label>Contract Title</label>
    <input id="title" placeholder="Contract title" required />

    <label>Description</label>
    <input id="description" placeholder="Description" required />

    <label>Payment Method</label>
    <div class="dropdown" id="paymentDropdown">
      <div class="dropdown-selected">Select payment method</div>
      <div class="dropdown-options" id="paymentOptions">
        <div data-value="paystack" style="font-weight:500">Paystack (Card/Bank)</div>
        <div data-value="wallet" style="font-weight:500">Wallet — <span id="walletInlineBalance" style="color:#00a86b;font-weight:600">₦0.00</span></div>
      </div>
    </div>

    <div id="amountGroup">
      <label>Amount (<span id="currencyLabel">₦</span>)</label>
      <input id="amount" type="number" placeholder="Enter amount" required />
    </div>

    <div id="chargeSection">
      <label>Who Pays the SafeNode Fee?</label>
      <div class="dropdown" id="chargeDropdown">
        <div class="dropdown-selected">Select option</div>
        <div class="dropdown-options">
          <div data-value="buyer">Buyer Pays All (6%)</div>
          <div data-value="seller">Seller Pays All (6%)</div>
          <div data-value="split">Split 50 / 50</div>
        </div>
      </div>
    </div>

    <div id="feeSummary"></div>
    <button class="btn" type="submit" id="payBtn">Continue</button>
  </form>

  <div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <div class="loading-text">Processing Payment...</div>
  </div>
</div>

<div id="toast"></div>

<script>
const form = document.getElementById("contractForm");
const loader = document.getElementById("loader");
const payBtn = document.getElementById("payBtn");
const amountInput = document.getElementById("amount");
const amountGroup = document.getElementById("amountGroup");
const chargeSection = document.getElementById("chargeSection");
const feeSummary = document.getElementById("feeSummary");
const currencyLabel = document.getElementById("currencyLabel");
const walletInlineBalance = document.getElementById("walletInlineBalance");

function showLoader(text="Processing..."){ loader.querySelector(".loading-text").textContent=text; loader.classList.add("active"); }
function hideLoader(){ loader.classList.remove("active"); }



const buyerId = localStorage.getItem("ui");
if(!buyerId){ showToast("⚠️ Please log in first.","error"); setTimeout(()=>window.location.href="/auth",1500); }

let buyerEmail=null;
let walletBalance=0;
let walletCurrency="₦";

async function getUserInfo(){
  try{
    const res = await fetch(`/api/users/${buyerId}`, { credentials:"include" });
    const data = await res.json();
    if(data.success && data.user){
      buyerEmail = data.user.email;
      walletBalance = data.user.wallet?.balance || 0;
      walletCurrency = data.user.currency==="USDT"?"USDT":data.user.currency==="USD"?"$":data.user.currency==="EUR"?"€":data.user.currency==="GBP"?"£":"₦";
      walletInlineBalance.textContent = walletCurrency==="USDT"?`${walletBalance.toFixed(2)} USDT`:`${walletCurrency}${walletBalance.toFixed(2)}`;
    } else throw new Error("Invalid user data");
  }catch(err){
    console.error("❌ Error fetching user:",err);
    localStorage.removeItem("ui");
    setTimeout(()=>window.location.href="/auth",2000);
  }
}

document.addEventListener("DOMContentLoaded", async () => { payBtn.disabled=true; await getUserInfo(); payBtn.disabled=false; });

// Dropdown logic
function setupDropdown(id,callback){
  const dropdown=document.getElementById(id);
  const selected=dropdown.querySelector(".dropdown-selected");
  const options=dropdown.querySelector(".dropdown-options");
  selected.addEventListener("click",()=>{ dropdown.classList.toggle("active"); });
  options.querySelectorAll("div").forEach(opt=>{
    opt.addEventListener("click",()=>{
      selected.textContent=opt.textContent;
      dropdown.classList.remove("active");
      callback(opt.dataset.value);
    });
  });
  document.addEventListener("click",(e)=>{ if(!dropdown.contains(e.target)) dropdown.classList.remove("active"); });
}

let paymentMethod="", chargePayer="";
setupDropdown("paymentDropdown", (value)=>{
  paymentMethod=value;
  if(!value){ amountGroup.style.display="none"; chargeSection.style.display="none"; feeSummary.style.display="none"; }
  else{ amountGroup.style.display="block"; currencyLabel.textContent=walletCurrency; }
});
setupDropdown("chargeDropdown", (value)=>{ chargePayer=value; updateFeeSummary(); });

amountInput.addEventListener("input", ()=>{ chargeSection.style.display=amountInput.value>0?"block":"none"; updateFeeSummary(); });

function updateFeeSummary(){
  const amount=parseFloat(amountInput.value)||0;
  if(!amount || !chargePayer) return feeSummary.style.display="none";
  const fee=amount*0.06;
  let total=amount;
  if(chargePayer==="buyer") total=amount+fee;
  else if(chargePayer==="split") total=amount+fee/2;
  const fmt=amt=>walletCurrency==="USDT"?`${amt.toFixed(2)} USDT`:`${walletCurrency}${amt.toFixed(2)}`;
  let text=`<strong>SafeNode Fee (6%):</strong> ${fmt(fee)}<br>`;
  if(chargePayer==="buyer") text+=`You pay <strong>${fmt(total)}</strong> total.`;
  else if(chargePayer==="seller") text+=`Seller receives <strong>${fmt(amount-fee)}</strong>.`;
  else text+=`Buyer pays <strong>${fmt(amount+fee/2)}</strong>, seller contributes <strong>${fmt(fee/2)}</strong>.`;
  feeSummary.innerHTML=text; feeSummary.style.display="block";
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!buyerEmail) return showToast("Please wait, verifying account...","error");
  const title=document.getElementById("title").value.trim();
  const description=document.getElementById("description").value.trim();
  const amount=parseFloat(amountInput.value);
  if(!paymentMethod || !amount || !chargePayer) return showToast("Please fill all required fields.","error");
  if(paymentMethod==="wallet" && amount>walletBalance) return showToast(`Insufficient wallet balance (${walletCurrency}${walletBalance.toFixed(2)}).`,'error');
  
  showLoader("Creating contract...");
  payBtn.disabled=true;
  try{
    const payload={title,description,amount,buyerEmail,paymentMethod,chargePayer};
    const res=await fetch(`/api/contracts/create`,{
      method:"POST",
      credentials:"include",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    hideLoader(); payBtn.disabled=false;
    if(data.success){
      if(paymentMethod==="wallet") window.location.href=`/success?id=${data.contractId}`;
      else if(data.paymentUrl) window.location.href=data.paymentUrl;
    } else showToast(data.message || "Failed to create contract.",'error');
  } catch(err){ hideLoader(); payBtn.disabled=false; console.error("Network error:",err); showToast("⚠️ Cannot reach server. Try again.",'error'); }
});
</script>
</body>
</html>