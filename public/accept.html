<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png">
  <title>SafeNode — Accept Contract</title>
<script src="/dashboard/actions.js"></script>
  <style>
    :root {
      --primary: #00a86b;
      --primary-light: #d4f7e8;
      --text-dark: #1a1a1a;
      --text-light: #777;
      --bg-gradient: linear-gradient(135deg, #f6fbff 0%, #f3fff9 100%);
      --card-bg: #ffffffcc;
      --radius: 20px;
      --shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      --input-border: #ccc;
      --transition: 0.3s ease;
    }

    * { box-sizing: border-box; font-family: "Inter", sans-serif; margin:0; padding:0; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: var(--bg-gradient);
      background-size: 600% 600%;
      animation: gradientShift 15s ease infinite;
      position: relative;
      overflow: hidden;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    canvas#bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .card {
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 480px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 40px 35px;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.6s ease;
      transition: transform 0.3s ease;
    }

    .card:hover { transform: translateY(-5px); }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      font-weight: 700;
      font-size: 28px;
      color: var(--primary);
    }

    .logo img { width:32px; height:32px;border-radius: 10px; margin-right: 10px; }

    h2 {
      text-align: center;
      color: var(--text-dark);
      margin-bottom: 25px;
      font-size: 24px;
    }

    .info {
      background: #f7f9fc;
      border:none;
      border-radius: 14px;
      padding: 18px 16px;
      font-size: 15px;
      color: #0a3f2f;
      margin-bottom: 20px;
    }

    .info p {
      margin: 8px 0;
      line-height: 1.55;
      border-bottom: 1px solid #edf4f1;
      padding-bottom: 6px;
    }

    .info p:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .info strong { color:black; font-weight:600; }

    .desc-label { display:block; font-weight:600; color:black; margin:10px 0 6px; font-size:14px; }

    .desc {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14.5px;
      color: #073728;
      line-height:1.5;
      border-left: 3px solid var(--primary);
      box-shadow: 0 0 0 1px #e8f3ed;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
    }

    .btn:hover { opacity: 0.93; transform: translateY(-2px); }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }

    .msg {
      text-align:center;
      margin-top:16px;
      font-weight:600;
      font-size:14px;
    }
    .error { color:#d43b3b; }
    .success { color: var(--primary); }

    /* Popup modal */
    .popup {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      backdrop-filter: blur(2px);
    }

    .popup-content {
      max-width:380px;
      width:90%;
      padding:40px 30px;
      text-align:center;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
      transform: scale(0.9);
      opacity:0;
      transition: all 0.25s ease;
      position:relative;
    }

    .popup.active .popup-content { transform: scale(1); opacity:1; }

    .popup-content h3 {
      font-size:20px;
      font-weight:600;
      color: var(--text-dark);
      margin-bottom:12px;
    }
    .popup-text { font-size:14.5px; color:var(--text-light); margin-bottom:22px; line-height:1.5; }

    .popup-buttons {
      display:flex;
      justify-content:center;
      gap:14px;
    }
    .popup-buttons .btn { flex:1; font-size:15px; padding:12px 0; border-radius:12px; font-weight:600; transition: all 0.25s ease, box-shadow 0.25s ease; }
    .popup-buttons .confirm { background: var(--primary); color:#fff; }
    .popup-buttons .confirm:hover { animation:pulse 1s infinite; box-shadow:0 0 15px rgba(0,168,107,0.45); transform:translateY(-2px); }
    .popup-buttons .cancel { background:#f0f0f0; color:#333; }
    .popup-buttons .cancel:hover { background:#ddd; transform:translateY(-2px); }

    @keyframes pulse { 0%{box-shadow:0 0 15px rgba(0,168,107,0.45);}50%{box-shadow:0 0 25px rgba(0,168,107,0.55);}100%{box-shadow:0 0 15px rgba(0,168,107,0.45);} }
    .close-btn { position:absolute; top:14px; right:14px; background:transparent; border:none; font-size:22px; font-weight:700; color:#777; cursor:pointer; transition: all 0.2s ease; }
    .close-btn:hover { color: var(--text-dark); transform: scale(1.1); }

    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    @media(max-width:480px){.card{padding:35px 20px;} h2{font-size:20px;} .desc{font-size:13.5px;} .btn{padding:12px; font-size:15px;}}
  </style>
  
<style>
    :root{
      --primary:#00a86b;
      --primary-light:#d4f7e8;
      --dark:#111;
      --gray:#555;
      --bg-gradient:linear-gradient(135deg,#f6fbff 0%,#f3fff9 100%);
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --ease-cubic:cubic-bezier(.2,.9,.2,1);
    }
.loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  visibility: hidden;
  opacity: 0;
  transition: opacity .3s ease, visibility .3s ease;
}

.loader-overlay.active {
  visibility: visible;
  opacity: 1;
}

.spin {
  width: 30px;   /* smaller size */
  height: 30px;
  border: 4px solid var(--primary-light); /* light part of the circle */
  border-top-color: var(--primary);      /* active color */
  border-radius: 50%;
  animation: spinn 0.8s linear infinite;
}

@keyframes spinn {
  to { transform: rotate(360deg); }
}


</style>
</head>
<body>
  <canvas id="bg"></canvas>
<div id="fullPageLoader" class="loader-overlay">
  <div style="text-align:center;">
    <div class="spin"></div>

  </div>
</div>
  <div class="card">
    <div class="logo">
      <img src="../logo.png" alt="SafeNode Logo" /> SafeNode
    </div>

    <h2>You have been invited to join this Escrow contract . </h2>
    <div class="info" id="contractInfo">
      <p>Loading contract details...</p>
    </div>

    <button id="acceptBtn" class="btn">Accept Contract</button>
    <div id="message" class="msg"></div>
  </div>

  <!-- Popup -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <button class="close-btn" id="popupClose">&times;</button>
      <h3>Confirm Contract Acceptance</h3>
      <p class="popup-text">Once accepted, this contract will be finalized. Are you sure you want to proceed?</p>
      <div class="popup-buttons">
        <button class="confirm btn" id="confirmYes">Yes, Accept</button>
        <button class="cancel btn" id="confirmNo">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

<script>
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let particles = [];
function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
window.addEventListener("resize",resize);
resize();
for(let i=0;i<60;i++){particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*2+1,dx:(Math.random()-0.5)*0.7,dy:(Math.random()-0.5)*0.7});}
function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="rgba(0,168,107,0.25)";particles.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();p.x+=p.dx;p.y+=p.dy;if(p.x<0||p.x>canvas.width)p.dx*=-1;if(p.y<0||p.y>canvas.height)p.dy*=-1;});requestAnimationFrame(draw);}
draw();

// Contract Logic
const contractInfo = document.getElementById("contractInfo");
const messageBox = document.getElementById("message");
const acceptBtn = document.getElementById("acceptBtn");
const popup = document.getElementById("popup");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const popupClose = document.getElementById("popupClose");

const contractId = new URLSearchParams(window.location.search).get("contract");
let sellerEmail = null;
let buyerEmail = null;

const showMessage = (text,type="error")=>{messageBox.textContent=text;messageBox.className=`msg ${type}`;};
if(!contractId) window.location.href="/404";

async function getUserEmail(){
  try{
    const userId=localStorage.getItem("ui");
    if(!userId) throw new Error("Missing user ID");
    const res = await fetch(`/api/users/${userId}`);
    const data = await res.json();
    if(data.success && data.user?.email) sellerEmail = data.user.email;
    else throw new Error();
  }catch{ showMessage("Please log in again.","error"); setTimeout(()=>window.location.href="/auth",1200);}
}
const loaderOverlay = document.getElementById("fullPageLoader");

async function loadContract(){
  try{
        const res = await fetch(`/api/contracts/${contractId}`);
    const data = await res.json();
    if(!data.success || !data.data){window.location.href="/404";return;}
    loaderOverlay.classList.remove("active"); // show loader
    const c = data.data;
    buyerEmail = c.buyer;

    const amount = Number(c.amount).toLocaleString();
    let formattedAmount = c.currency==="USD"?"$"+amount:c.currency==="GBP"?"£"+amount:c.currency==="EUR"?"€"+amount:c.currency==="NGN"?"₦"+amount:amount+" "+(c.currency||"");

    if(["accepted","completed","disputed"].includes(c.status)){
      contractInfo.innerHTML=`<p><strong>Title:</strong>${c.title}</p><p><strong>Seller:</strong>${c.sellername}</p><span class="desc-label">Description:</span><div class="desc">${c.description}</div><p><strong>Amount:</strong>${formattedAmount}</p><p><strong>Status:</strong>${c.status}</p><p><strong>Created:</strong>${new Date(c.createdAt).toLocaleString()}</p>`;
      acceptBtn.style.display="none";
      window.location.href=`/accepted?id=${contractId}`;
      return;
    }

    if(c.status!=="funded"){contractInfo.innerHTML=`<p style="color:#d33;text-align:center;">Invalid or Unfunded Contract.</p>`;acceptBtn.style.display="none";return;}

    contractInfo.innerHTML=`<p><strong>Title:</strong>${c.title}</p><span class="desc-label">Description:</span><div class="desc">${c.description}</div><p><strong>Amount:</strong>${formattedAmount}</p><p><strong>Buyer:</strong>${c.buyer}</p><p><strong>Charge Payer:</strong>${c.chargePayer}</p><p><strong>Status:</strong>${c.status}</p><p><strong>Created:</strong>${new Date(c.createdAt).toLocaleString()}</p>`;
  }catch(err){console.error(err);window.location.href="/dashboard";}
}

// Popup handlers
function openPopup(){ popup.style.display="flex"; setTimeout(()=>popup.classList.add("active"),10); }
function closePopup(){ popup.classList.remove("active"); setTimeout(()=>{popup.style.display="none";},250);}
popupClose.addEventListener("click",closePopup);
confirmNo.addEventListener("click",closePopup);

acceptBtn.addEventListener("click",()=>{
  if(!sellerEmail) return showMessage("Please wait...","error");
  if(sellerEmail.toLowerCase()===buyerEmail.toLowerCase()) return showMessage("You cannot accept your own contract.","error");
  openPopup();
});

confirmYes.addEventListener("click",async ()=>{
  closePopup();
  acceptBtn.disabled=true; acceptBtn.textContent="Processing...";
  try{
    const res=await fetch(`/api/contracts/accept/${contractId}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:sellerEmail})});
    const data = await res.json();
    if(data.success){acceptBtn.textContent="Accepted"; window.location.href=`/accepted?id=${contractId}`;}
    else{showMessage(data.message||"Failed to accept contract.","error");acceptBtn.textContent="Accept Contract";}
  }catch{showMessage("Network error.","error");acceptBtn.textContent="Accept Contract";}
  finally{acceptBtn.disabled=false;}
});

document.addEventListener("DOMContentLoaded",async ()=>{
  loaderOverlay.classList.add("active"); // show loader

  acceptBtn.disabled=true;
  await getUserEmail();
  await loadContract();
  acceptBtn.disabled=false;
});

// Toast

</script>
</body>
</html>