<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeNode - Escrow Receipt</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="/dashboard/actions.js"></script>
<style>
:root{
  --primary:#00a86b;
  --primary-dark:#009a47;
  --bg-gradient: linear-gradient(135deg,#f4fdf7 0%,#f8fbff 100%);
  --card-bg:#ffffffcc;
  --shadow:0 15px 40px rgba(0,0,0,0.1);
  --text-dark:#111;
  --text-muted:#777;
}
body{
  margin:0; padding:20px;
  font-family:'Inter',sans-serif;
  background:var(--bg-gradient);
  display:flex; justify-content:center; align-items:center;
  min-height:100vh;
}
.receipt-container{
  background:var(--card-bg);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:40px 30px;
  width:100%;
  max-width:460px;
  text-align:center;
  position:relative;
}
.logo{ display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:20px;}
.logo img{ width:36px; height:36px; border-radius:8px;}
.logo span{ font-size:22px; font-weight:700; color:var(--primary);}
.checkmark{ font-size:80px; color:var(--primary); margin:15px 0; }
h2{ margin:10px 0; color:#0b513f; }
p.subtitle{ color:var(--text-muted); font-size:14px; margin-bottom:25px;}
.details{
  background:#f7f9fc;
  border-radius:12px;
  padding:16px;
  text-align:left;
  font-size:14px;
  margin-bottom:20px;
}
.details p{ margin:6px 0; color:var(--text-dark);}
.details b{ color:#000;}
.share-info{
  font-size:15px;
  font-weight:700;
  margin-bottom:20px;
  word-wrap:break-word;
}
.share-info a{
  color:var(--primary);
  text-decoration:none;
}
.share-info a:hover{ text-decoration:underline;}
.actions{
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.btn{
  flex:1;
  background:var(--primary);
  color:#fff;
  border:none;
  padding:12px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}
.btn:hover{ background:var(--primary-dark);}
#toast{
  position:fixed;
  bottom:30px; left:50%;
  transform:translateX(-50%);
  background:#333; color:#fff;
  padding:12px 20px;
  border-radius:8px;
  font-size:14px;
  opacity:0; pointer-events:none;
  z-index:9999;
  transition:opacity 0.3s ease;
}
#toast.show{ opacity:1; pointer-events:auto;}
.footer{ margin-top:25px; font-size:12px; color:#aaa;}
</style>
</head>
<body>

<div class="receipt-container" id="receipt">
  <div class="logo">
    <img src="../logo.png" alt="SafeNode Logo">
    <span>SafeNode</span>
  </div>

  <h2 id="statusTitle">Escrow Funded Successfully</h2>
  <p class="subtitle" id="statusSubtitle">Funds are securely held by SafeNode until completion.</p>

  <div class="details" id="receiptDetails">
    <p><b>Contract ID:</b> —</p>
    <p><b>Title:</b> —</p>
    <p><b>Description:</b> —</p>
    <p><b>Amount:</b> —</p>
    <p><b>Charge Payer:</b> —</p>
    <p><b>Status:</b> —</p>
    <p><b>Date:</b> —</p>
  </div>

  <p class="share-info" id="shareInfo">
    Share this link with the seller to continue the escrow:<br>
    <a id="sellerLink" href="#" target="_blank"></a>
  </p>

  <div class="actions" id="actions">
    <button class="btn" id="copyBtn">Copy Link</button>
    <button class="btn" id="shareBtn">Share</button>
  </div>

  <p class="footer">Powered by SafeNode Escrow Services</p>
</div>

<div id="toast"></div>

<script>
const params=new URLSearchParams(window.location.search);
const contractId=params.get("id");
const receiptDetails=document.getElementById("receiptDetails");
const statusTitle=document.getElementById("statusTitle");
const statusSubtitle=document.getElementById("statusSubtitle");
const copyBtn=document.getElementById("copyBtn");
const shareBtn=document.getElementById("shareBtn");
const sellerLinkEl=document.getElementById("sellerLink");
const actions=document.getElementById("actions");
const shareInfo=document.getElementById("shareInfo");
const toast=document.getElementById("toast");
const domain=window.location.origin;
const sellerLink=`${domain}/accept?contract=${contractId}`;



async function loadContract(){
  if(!contractId){statusTitle.textContent="Invalid Link"; statusSubtitle.textContent="Missing contract ID in URL."; return;}
  try{
    const res=await fetch(`/api/contracts/${contractId}`);
    const data=await res.json();
    if(!data.success) throw new Error("Failed to fetch contract data.");
    const c=data.data;
    const amountText=c.currency==="USDT"?`${c.amount.toFixed(2)} ${c.currency}`:`₦${Number(c.amount).toLocaleString()}`;

    receiptDetails.innerHTML=`
      <p><b>Contract ID:</b> ${c._id}</p>
      <p><b>Title:</b> ${c.title||"—"}</p>
      <p><b>Description:</b> ${c.description||"—"}</p>
      <p><b>Amount:</b> ${amountText}</p>
      <p><b>Charge Payer:</b> ${c.chargePayer?c.chargePayer.charAt(0).toUpperCase()+c.chargePayer.slice(1):"—"}</p>
      <p><b>Status:</b> ${c.status?c.status.charAt(0).toUpperCase()+c.status.slice(1):"Pending"}</p>
      <p><b>Date:</b> ${new Date(c.createdAt).toLocaleString()}</p>
    `;

    sellerLinkEl.textContent=sellerLink;
    sellerLinkEl.href=sellerLink;

    if(c.status==="funded"){statusTitle.textContent="Escrow Funded Successfully"; statusSubtitle.textContent="Funds are securely held by SafeNode until completion.";}
    else if(c.status==="pending"){statusTitle.textContent="Payment Pending"; statusSubtitle.textContent="Your payment is being confirmed.";}
    else if(c.status==="failed"){statusTitle.textContent="Payment Failed"; statusSubtitle.textContent="There was an issue processing your payment.";}
  }catch(err){console.error(err); statusTitle.textContent="Error Loading Contract"; statusSubtitle.textContent="Please refresh or contact support.";}
}

copyBtn.addEventListener("click",()=>{navigator.clipboard.writeText(sellerLink); showToast("Link Copied!");});
shareBtn.addEventListener("click",async()=>{
  actions.style.display="none"; shareInfo.style.display="none";
  const canvas=await html2canvas(document.getElementById("receipt"),{scale:3, backgroundColor:"#ffffff", useCORS:true});
  canvas.toBlob(async(blob)=>{
    const file=new File([blob],`SafeNode_Receipt_${contractId}.png`,{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      try{await navigator.share({title:"SafeNode Escrow Receipt", text:`Join this escrow using the link:\n${sellerLink}`, files:[file]});}
      catch(err){console.error(err);}
    }else{navigator.clipboard.writeText(sellerLink); showToast("Link copied! Share the receipt image manually.");}
  });
  actions.style.display="flex"; shareInfo.style.display="block";
});

loadContract();
</script>
</body>
</html>