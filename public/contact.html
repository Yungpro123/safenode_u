<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeNode — Secure Payment</title>
<link rel="icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="https://i.ibb.co/bRF2crW9/file-0000000042b061f4bc562118dc9e4f44.png">
<script src="/dashboard/actions.js"></script>
<style>
/* Base Styles */
* { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
body {
    margin:0;
    padding:16px;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background: linear-gradient(135deg,#f0f5ff 0%,#e8f9f0 100%);
    color:#1c1c1c;
}

/* Slide-up Animation */
@keyframes slideUp {
    0% {
        opacity: 0;
        transform: translateY(50px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Card */
.card {
    width:100%;
    max-width:420px;
    background:#fff;
    border-radius:20px;
    padding:32px 28px;
    box-shadow:0 20px 40px rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    gap:18px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;

    /* Slide-up Animation */
    opacity: 0;
    animation: slideUp 0.6s ease-out forwards;
    animation-delay: 0.2s;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.12);
}

/* Logo */
.logo {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:10px;
}
.logo img {
    width:36px;
    height:36px;
    border-radius:8px;
    transition: transform 0.3s ease;
}
.logo img:hover { transform: scale(1.1); }
.logo h1{font-size:1.3rem;font-weight:800;color:#00a86b;margin:0;}

/* Headings */
h2 {
    font-size:20px;
    font-weight:600;
    text-align:center;
    color:#0b513f;
    margin:0;
}

/* Labels & Inputs */
label {
    display:block;
    font-weight:600;
    font-size:15px;
    margin-top:16px;
}
input {
    width:100%;
    padding:14px;
    font-size:15px;
    margin-top:6px;
    border-radius:10px;
    border:1px solid #e0e0e0;
    transition: all 0.25s ease, transform 0.2s ease;
}
input:focus {
    outline:none;
    border-color:#00bb55;
    box-shadow:0 6px 20px rgba(0,187,85,0.1);
    transform:scale(1.01);
}

/* Buttons */
.btn {
    width:100%;
    padding:14px;
    border-radius:12px;
    border:none;
    font-weight:700;
    font-size:16px;
    color:#fff;
    background: linear-gradient(135deg,#00a86b,#00945f);
    cursor:pointer;
    transition: all 0.2s ease, transform 0.1s ease;
    margin-top:22px;
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,168,107,0.15);}
.btn:active { transform: scale(0.97); }

/* Loader Overlay */
.loader-overlay {
    position:absolute;
    inset:0;
    background:rgba(255,255,255,0.85);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    border-radius:20px;
    opacity:0;
    visibility:hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}
.loader-overlay.active { opacity:1; visibility:visible; }
.spinner {
    border:4px solid #e0e0e0;
    border-top:4px solid #00bb55;
    border-radius:50%;
    width:36px;
    height:36px;
    animation:spin 1s linear infinite;
    margin-bottom:12px;
}
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { font-size:14px; font-weight:600; color:#333; }

/* Fee Summary */
#feeSummary {
    display:none;
    font-size:14px;
    color:#055e38;
    background:#f7fef9;
    border:1px solid #dff5e5;
    border-radius:10px;
    padding:12px 14px;
    margin-top:14px;
    line-height:1.5;
}

/* Dropdown */
.dropdown {
    position:relative;
    user-select:none;
    margin-top:6px;
}
.dropdown-selected {
    padding:12px;
    border-radius:10px;
    border:1px solid #e0e0e0;
    cursor:pointer;
    transition:all 0.25s ease, transform 0.1s ease;
}
.dropdown-selected:hover { border-color:#00bb55; box-shadow:0 0 8px rgba(0,187,85,0.15);}
.dropdown-selected:active { transform:scale(0.98); }
.dropdown-options {
    position:absolute;
    top:calc(100% + 4px);
    left:0; right:0;
    max-height:0;
    opacity:0;
    pointer-events:none;
    background:#fff;
    border-radius:12px;
    border:1px solid #e0e0e0;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    overflow:hidden;
    transition:max-height 0.3s ease, opacity 0.25s ease;
    z-index:10;
}
.dropdown.active .dropdown-options {
    max-height:180px;
    opacity:1;
    pointer-events:auto;
}
.dropdown-options div {
    padding:12px 14px;
    font-size:14px;
    cursor:pointer;
    transition: background 0.2s ease;
}
.dropdown-options div:hover { background:#e8f9f0; }

/* Hidden sections */
#amountGroup, #chargeSection { display:none; }

/* Responsive */
@media(max-width:480px){
    .card { padding:24px 18px; }
    .logo h1 { font-size:20px; }
    h2 { font-size:18px; }
    input, .dropdown-selected { font-size:14px; padding:12px; }
    .btn { font-size:15px; padding:12px; }
    #feeSummary { font-size:13px; padding:10px 12px; }
}
</style>
</head>

<body>
<div class="card">
    <div class="logo">
        <img src="../logo.png" alt="SafeNode Logo">
        <h1>SafeNode</h1>
    </div>
    <h2>Start a Secure Payment</h2>

    <form id="contractForm">
        <label>Contract Title</label>
        <input id="title" placeholder="Enter contract title" required>

        <label>Description</label>
        <input id="description" placeholder="Enter a short description" required>

        <label>Payment Method</label>
        <div class="dropdown" id="paymentDropdown">
            <div class="dropdown-selected">Select payment method</div>
            <div class="dropdown-options" id="paymentOptions">
                <div data-value="paystack">Paystack (Card/Bank)</div>
                <div data-value="wallet">Wallet — <span id="walletInlineBalance" style="color:#00a86b;font-weight:600">₦0.00</span></div>
            </div>
        </div>

        <div id="amountGroup">
            <label>Amount (<span id="currencyLabel">₦</span>)</label>
            <input id="amount" type="number" placeholder="Enter amount" required>
        </div>

        <div id="chargeSection">
            <label>Who Pays the SafeNode Fee?</label>
            <div class="dropdown" id="chargeDropdown">
                <div class="dropdown-selected">Select option</div>
                <div class="dropdown-options">
                    <div data-value="buyer">Buyer Pays All (6%)</div>
                    <div data-value="seller">Seller Pays All (6%)</div>
                    <div data-value="split">Split 50 / 50</div>
                </div>
            </div>
        </div>

        <div id="feeSummary"></div>
        <button class="btn" type="submit" id="payBtn">Continue</button>
    </form>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <div class="loading-text">Processing Payment...</div>
    </div>
</div>

<script>
// Same JS as original
const form = document.getElementById("contractForm");
const loader = document.getElementById("loader");
const payBtn = document.getElementById("payBtn");
const amountInput = document.getElementById("amount");
const amountGroup = document.getElementById("amountGroup");
const chargeSection = document.getElementById("chargeSection");
const feeSummary = document.getElementById("feeSummary");
const currencyLabel = document.getElementById("currencyLabel");
const walletInlineBalance = document.getElementById("walletInlineBalance");

function showLoader(text="Processing..."){ loader.querySelector(".loading-text").textContent=text; loader.classList.add("active"); }
function hideLoader(){ loader.classList.remove("active"); }

const buyerId = localStorage.getItem("ui");
if(!buyerId){ showToast("Please log in first" , 'error'); setTimeout(()=>window.location.href="/auth",1500); }

let buyerEmail=null, walletBalance=0, walletCurrency="₦";

async function getUserInfo(){
    try{
        const res=await fetch(`/api/users/${buyerId}`,{credentials:"include"});
        const data=await res.json();
        if(data.success && data.user){
            buyerEmail=data.user.email;
            walletBalance=data.user.wallet?.balance||0;
            const cur=data.user.currency||"NGN";
            walletCurrency = cur==="USDT"?"USDT":cur==="USD"?"$":cur==="GBP"?"£":cur==="EUR"?"€":"₦";
            walletInlineBalance.textContent = walletCurrency==="USDT"?`${walletBalance.toFixed(2)} USDT`:`${walletCurrency}${walletBalance.toFixed(2)}`;
        } else throw new Error("Invalid user data");
    } catch(err){ console.error(err); localStorage.removeItem("ui"); setTimeout(()=>window.location.href="/auth",2000);}
}

document.addEventListener("DOMContentLoaded", async ()=>{
    payBtn.disabled=true;
    await getUserInfo();
    payBtn.disabled=false;
});

// Dropdown logic
function setupDropdown(id,callback){
    const dropdown=document.getElementById(id);
    const selected=dropdown.querySelector(".dropdown-selected");
    const options=dropdown.querySelector(".dropdown-options");
    selected.addEventListener("click",()=>dropdown.classList.toggle("active"));
    options.querySelectorAll("div").forEach(opt=>{
        opt.addEventListener("click",()=>{
            selected.textContent=opt.textContent;
            dropdown.classList.remove("active");
            callback(opt.dataset.value);
        });
    });
    document.addEventListener("click",(e)=>{if(!dropdown.contains(e.target))dropdown.classList.remove("active");});
}

let paymentMethod="", chargePayer="";
setupDropdown("paymentDropdown",(value)=>{
    paymentMethod=value;
    if(!value){amountGroup.style.display="none"; chargeSection.style.display="none"; feeSummary.style.display="none";}
    else{ amountGroup.style.display="block"; currencyLabel.textContent=value==="wallet"?walletCurrency:value==="usdt"?"USDT":"₦"; }
});
setupDropdown("chargeDropdown",(value)=>{ chargePayer=value; updateFeeSummary(); });
amountInput.addEventListener("input",()=>{ parseFloat(amountInput.value)>0?chargeSection.style.display="block":chargeSection.style.display="none"; updateFeeSummary(); });

function updateFeeSummary(){
    const amount=parseFloat(amountInput.value)||0;
    if(!amount || !chargePayer){ feeSummary.style.display="none"; return; }
    const fee=amount*0.06;
    let total=amount;
    if(chargePayer==="buyer") total=amount+fee;
    else if(chargePayer==="split") total=amount+fee/2;
    const formatAmt=amt=>walletCurrency==="USDT"?`${amt.toFixed(2)} USDT`:`${walletCurrency}${amt.toFixed(2)}`;
    let text=`<strong>SafeNode Fee (6%):</strong> ${formatAmt(fee)}<br>`;
    if(chargePayer==="buyer") text+=`You pay <strong>${formatAmt(total)}</strong> total.`;
    else if(chargePayer==="seller") text+=`Seller receives <strong>${formatAmt(amount-fee)}</strong>.`;
    else text+=`Buyer pays <strong>${formatAmt(amount+fee/2)}</strong>, seller contributes <strong>${formatAmt(fee/2)}</strong>.`;
    feeSummary.innerHTML=text; feeSummary.style.display="block";
}

form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!buyerEmail) return showToast("Please wait, verifying account...", 'success');
    const title=document.getElementById("title").value.trim();
    const description=document.getElementById("description").value.trim();
    const amount=parseFloat(amountInput.value);
    if(!paymentMethod || !amount || !chargePayer) return showToast("Please fill all required fields.","error");
    if(paymentMethod==="wallet" && amount>walletBalance) return showToast(`Insufficient wallet balance (${walletCurrency}${walletBalance.toFixed(2)} available).`,'error');
    showLoader("Creating contract..."); payBtn.disabled=true;
    try{
        const res=await fetch(`/api/contracts/create`,{
            method:"POST",
            credentials:"include",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({title,description,amount,buyerEmail,paymentMethod,chargePayer})
        });
        const data=await res.json();
        hideLoader(); payBtn.disabled=false;
        if(data.success){
            if(paymentMethod==="wallet") window.location.href=`/success?id=${data.contractId}`;
            else if(data.paymentUrl) window.location.href=data.paymentUrl;
        } else showToast(data.message || "Failed to create contract.",'error');
    }catch(err){ hideLoader(); payBtn.disabled=false; console.error(err); showToast("Cannot reach server. Try again.",'error'); }
});
</script>
</body>
</html>